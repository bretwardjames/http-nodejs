<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLE Configuration Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .top-bar {
      background: white;
      border-bottom: 1px solid #e1e8ed;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .top-bar h1 {
      font-size: 24px;
      color: #333;
    }

    .top-bar .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info span {
      color: #666;
      font-size: 14px;
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #c0392b;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e1e8ed;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      position: relative;
      bottom: -2px;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #333;
      padding-bottom: 10px;
      border-bottom: 1px solid #e1e8ed;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-group {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .input-group input {
      flex: 1;
    }

    .input-group button {
      padding: 10px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: background 0.3s;
    }

    .input-group button:hover {
      background: #5568d3;
    }

    .validation-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin-top: 5px;
      min-height: 20px;
    }

    .validation-status.valid {
      color: #27ae60;
    }

    .validation-status.invalid {
      color: #e74c3c;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .validation-status.valid .status-indicator {
      background: #27ae60;
    }

    .validation-status.invalid .status-indicator {
      background: #e74c3c;
    }

    .validation-status.checking .status-indicator {
      background: #f39c12;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .image-preview {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #e1e8ed;
    }

    .image-preview.loading {
      text-align: center;
      color: #999;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 4px;
      margin-bottom: 10px;
      border: 2px solid #667eea;
    }

    .preview-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .side-by-side {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .side-by-side {
        grid-template-columns: 1fr;
      }
    }

    .preview-item {
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #e1e8ed;
    }

    .preview-item h4 {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .preview-item img {
      width: 100%;
      height: auto;
      max-height: 200px;
      object-fit: contain;
      border-radius: 4px;
    }

    .preview-item.no-image {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 150px;
      color: #999;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-save {
      background: #27ae60;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-save:hover {
      background: #229954;
    }

    .btn-save:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-reset {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-reset:hover {
      background: #7f8c8d;
    }

    .btn-copy-next {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-copy-next:hover {
      background: #2980b9;
    }

    .btn-copy-next:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .message {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: #d5f4e6;
      color: #27ae60;
      border-left: 4px solid #27ae60;
    }

    .message.error {
      background: #fadbd8;
      color: #e74c3c;
      border-left: 4px solid #e74c3c;
    }

    .message.info {
      background: #d6eaf8;
      color: #3498db;
      border-left: 4px solid #3498db;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .history-table th {
      background: #f5f7fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e1e8ed;
    }

    .history-table td {
      padding: 12px;
      border-bottom: 1px solid #e1e8ed;
    }

    .history-table tr:hover {
      background: #f9f9f9;
    }

    .variable-name {
      font-family: monospace;
      background: #f5f7fa;
      padding: 2px 6px;
      border-radius: 3px;
      color: #667eea;
      font-weight: 500;
    }

    .timestamp {
      color: #999;
      font-size: 13px;
    }

    .username {
      color: #667eea;
      font-weight: 500;
    }

    .value-change {
      font-family: monospace;
      font-size: 12px;
      color: #666;
      word-break: break-all;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .section-header {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e1e8ed;
    }

    .section-header h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }

    .section-header p {
      font-size: 12px;
      color: #999;
    }

    .grid-cols-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .before-switch-section {
      padding: 15px;
      border: 3px solid #667eea;
      border-radius: 8px;
      background: rgba(102, 126, 234, 0.03);
    }

    #settingsForm .form-group {
      margin-bottom: 5px;
    }

    .preview-item.before-switch {
      border: 3px solid #667eea !important;
      background: rgba(102, 126, 234, 0.03) !important;
    }

    .preview-item.after-switch-current {
      border: 3px solid #667eea !important;
      background: rgba(102, 126, 234, 0.03) !important;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>PLE Configuration</h1>
    <div class="user-info">
      <span>Logged in as: <strong id="usernameDisplay">Loading...</strong></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="message" id="successMessage"></div>
    <div class="message" id="errorMessage"></div>
    <div class="message" id="infoMessage"></div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('config')">Ticket Graphics</button>
      <button class="tab-btn" onclick="switchTab('preview')">Preview</button>
      <button class="tab-btn" onclick="switchTab('settings')">Other Settings</button>
      <button class="tab-btn" onclick="switchTab('history')">Change History</button>
      <button class="tab-btn" onclick="switchTab('users')">User Management</button>
    </div>

    <!-- Configuration Tab -->
    <div id="config" class="tab-content active">
      <div class="card">
        <h2>Promo Switch Configuration</h2>
        <div class="section-header">
          <h3>Switch Date</h3>
          <p>When you change this date, the ticket graphics will automatically switch to the "next" versions</p>
        </div>

        <div class="form-group">
          <label for="switchDate">Promo Switch Date (or "TBD" to disable)</label>
          <input type="text" id="switchDate" class="datepicker" placeholder="YYYY-MM-DD or TBD">
        </div>
      </div>

      <div class="card">
        <h2>General Admission Tickets</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- GA Desktop Before Switch -->
          <div>
            <div class="section-header">
              <h3>Desktop - Before switch</h3>
            </div>
            <div class="form-group">
              <label for="gaDesktop">URL</label>
              <div class="input-group">
                <input type="text" id="gaDesktop" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('gaDesktop')">Validate</button>
              </div>
              <div class="validation-status" id="gaDesktop-status"></div>
              <div class="image-preview" id="gaDesktop-preview" style="display: none;"></div>
            </div>
          </div>

          <!-- GA Desktop After Switch -->
          <div>
            <div class="section-header">
              <h3>Desktop - After switch</h3>
            </div>
            <div class="form-group">
              <label for="gaDesktopNext">URL</label>
              <div class="input-group">
                <input type="text" id="gaDesktopNext" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('gaDesktopNext')">Validate</button>
              </div>
              <div class="validation-status" id="gaDesktopNext-status"></div>
              <div class="image-preview" id="gaDesktopNext-preview" style="display: none;"></div>
            </div>
          </div>

          <!-- GA Mobile Before Switch -->
          <div>
            <div class="section-header">
              <h3>Mobile - Before switch</h3>
            </div>
            <div class="form-group">
              <label for="gaMobile">URL</label>
              <div class="input-group">
                <input type="text" id="gaMobile" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('gaMobile')">Validate</button>
              </div>
              <div class="validation-status" id="gaMobile-status"></div>
              <div class="image-preview" id="gaMobile-preview" style="display: none;"></div>
            </div>
          </div>

          <!-- GA Mobile After Switch -->
          <div>
            <div class="section-header">
              <h3>Mobile - After switch</h3>
            </div>
            <div class="form-group">
              <label for="gaMobileNext">URL</label>
              <div class="input-group">
                <input type="text" id="gaMobileNext" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('gaMobileNext')">Validate</button>
              </div>
              <div class="validation-status" id="gaMobileNext-status"></div>
              <div class="image-preview" id="gaMobileNext-preview" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Complimentary Tickets</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Comp Desktop Before Switch -->
          <div>
            <div class="section-header">
              <h3>Desktop - Before switch</h3>
            </div>
            <div class="form-group">
              <label for="compDesktop">URL</label>
              <div class="input-group">
                <input type="text" id="compDesktop" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('compDesktop')">Validate</button>
              </div>
              <div class="validation-status" id="compDesktop-status"></div>
              <div class="image-preview" id="compDesktop-preview" style="display: none;"></div>
            </div>
          </div>

          <!-- Comp Desktop After Switch -->
          <div>
            <div class="section-header">
              <h3>Desktop - After switch</h3>
            </div>
            <div class="form-group">
              <label for="compDesktopNext">URL</label>
              <div class="input-group">
                <input type="text" id="compDesktopNext" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('compDesktopNext')">Validate</button>
              </div>
              <div class="validation-status" id="compDesktopNext-status"></div>
              <div class="image-preview" id="compDesktopNext-preview" style="display: none;"></div>
            </div>
          </div>

          <!-- Comp Mobile Before Switch -->
          <div>
            <div class="section-header">
              <h3>Mobile - Before switch</h3>
            </div>
            <div class="form-group">
              <label for="compMobile">URL</label>
              <div class="input-group">
                <input type="text" id="compMobile" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('compMobile')">Validate</button>
              </div>
              <div class="validation-status" id="compMobile-status"></div>
              <div class="image-preview" id="compMobile-preview" style="display: none;"></div>
            </div>
          </div>

          <!-- Comp Mobile After Switch -->
          <div>
            <div class="section-header">
              <h3>Mobile - After switch</h3>
            </div>
            <div class="form-group">
              <label for="compMobileNext">URL</label>
              <div class="input-group">
                <input type="text" id="compMobileNext" placeholder="https://example.com/image.png">
                <button type="button" onclick="validateUrl('compMobileNext')">Validate</button>
              </div>
              <div class="validation-status" id="compMobileNext-status"></div>
              <div class="image-preview" id="compMobileNext-preview" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-save" onclick="previewConfig()">Preview Configuration</button>
        <button class="btn-copy-next" onclick="copyAfterSwitchToBefore()">Copy all After switch to Before switch</button>
        <button class="btn-reset" onclick="resetForm()">Reset</button>
      </div>
    </div>

    <!-- Preview Tab -->
    <div id="preview" class="tab-content">
      <div class="card">
        <h2>Graphics Preview</h2>
        <p style="color: #999; font-size: 14px; margin-bottom: 20px;">
          This shows a side-by-side comparison of Before switch and After switch graphics. The column highlighted in blue indicates which images are currently live based on your switch date. Review your changes and click Save Configuration to persist them.
        </p>
        <div class="side-by-side">
          <div class="preview-item" id="previewGADesktop">
            <h4>GA Desktop - Before switch</h4>
            <div class="no-image">No image URL</div>
          </div>
          <div class="preview-item" id="previewGADesktopNext">
            <h4>GA Desktop - After switch</h4>
            <div class="no-image">No image URL</div>
          </div>
          <div class="preview-item" id="previewGAMobile">
            <h4>GA Mobile - Before switch</h4>
            <div class="no-image">No image URL</div>
          </div>
          <div class="preview-item" id="previewGAMobileNext">
            <h4>GA Mobile - After switch</h4>
            <div class="no-image">No image URL</div>
          </div>
          <div class="preview-item" id="previewCompDesktop">
            <h4>Comp Desktop - Before switch</h4>
            <div class="no-image">No image URL</div>
          </div>
          <div class="preview-item" id="previewCompDesktopNext">
            <h4>Comp Desktop - After switch</h4>
            <div class="no-image">No image URL</div>
          </div>
          <div class="preview-item" id="previewCompMobile">
            <h4>Comp Mobile - Before switch</h4>
            <div class="no-image">No image URL</div>
          </div>
          <div class="preview-item" id="previewCompMobileNext">
            <h4>Comp Mobile - After switch</h4>
            <div class="no-image">No image URL</div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-save" onclick="saveConfig()">Save Configuration</button>
        <button class="btn-reset" onclick="switchTab('config')">Back to Configuration</button>
      </div>
    </div>

    <!-- Other Settings Tab -->
    <div id="settings" class="tab-content">
      <div class="card">
        <h2>Other Settings</h2>
        <p style="color: #999; font-size: 14px; margin-bottom: 20px;">
          Edit additional event and configuration settings such as event dates, location, venue, and checkout page graphics.
        </p>
        <div id="settingsForm"></div>
        <div class="button-group" style="margin-top: 20px;">
          <button class="btn-save" onclick="saveOtherSettings()">Save Settings</button>
          <button class="btn-reset" onclick="resetSettingsForm()">Reset</button>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="history" class="tab-content">
      <div class="card">
        <h2>Change History</h2>
        <p style="color: #999; font-size: 14px; margin-bottom: 20px;">
          All configuration changes are logged here for audit purposes.
        </p>
        <table class="history-table" id="historyTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Variable</th>
              <th>Changed By</th>
              <th>Old Value</th>
              <th>New Value</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr>
              <td colspan="5" class="empty-state">Loading history...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- User Management Tab -->
    <div id="users" class="tab-content">
      <div class="card">
        <h2>User Management</h2>
        <p style="color: #999; font-size: 14px; margin-bottom: 20px;">
          Create new admin users for managing PLE configuration.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
          <!-- Create User Form -->
          <div>
            <div class="section-header">
              <h3>Create New User</h3>
            </div>

            <div class="form-group">
              <label for="newUsername">Username</label>
              <input type="text" id="newUsername" placeholder="Enter username (min 3 characters)">
            </div>

            <div class="form-group">
              <label for="newPassword">Password</label>
              <input type="password" id="newPassword" placeholder="Enter password (min 6 characters)">
            </div>

            <button class="btn-save" onclick="createNewUser()" style="width: 100%;">Create User</button>
          </div>

          <!-- Users List -->
          <div>
            <div class="section-header">
              <h3>Existing Users</h3>
            </div>

            <div id="usersList" style="max-height: 400px; overflow-y: auto;">
              <div style="text-align: center; color: #999; padding: 20px;">
                Loading users...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Field mappings for API calls
    const fieldMappings = {
      switchDate: 'PLE_promo_promo_switchDate',
      gaDesktop: 'PLE_promo_ticketGraphicDesktop',
      gaDesktopNext: 'PLE_promo_ticketGraphicDesktop_next',
      gaMobile: 'PLE_promo_ticketGraphicMobile',
      gaMobileNext: 'PLE_promo_ticketGraphicMobile_next',
      compDesktop: 'PLE_promo_compTicketGraphicDesktop',
      compDesktopNext: 'PLE_promo_compTicketGraphicDesktop_next',
      compMobile: 'PLE_promo_compTicketGraphicMobile',
      compMobileNext: 'PLE_promo_compTicketGraphicMobile_next'
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      const authResponse = await fetch('/check-auth');
      const authData = await authResponse.json();

      if (!authData.authenticated) {
        window.location.href = '/admin';
        return;
      }

      document.getElementById('usernameDisplay').textContent = authData.username;

      // Initialize date picker
      flatpickr('#switchDate', {
        enableTime: false,
        dateFormat: 'Y-m-d',
        minDate: new Date()
      });

      // Load configuration
      await loadConfig();

      // Update preview highlights based on loaded switch date
      setTimeout(() => {
        updatePreviewHighlights();
      }, 100);

      // Load other settings
      await loadOtherSettings();

      // Load history
      await loadHistory();

      // Load users
      await loadUsers();

      // Add input listeners for live preview updates
      Object.keys(fieldMappings).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element && (fieldId.includes('Desktop') || fieldId.includes('Mobile'))) {
          element.addEventListener('input', () => {
            updateLivePreview(fieldId);
          });
        }
      });

      // Add listener to switch date to update config page highlighting
      const switchDateInput = document.getElementById('switchDate');
      if (switchDateInput) {
        switchDateInput.addEventListener('change', () => {
          updateConfigPageHighlights();
        });
      }

      // Initial highlight on load
      updateConfigPageHighlights();
    });

    async function loadConfig() {
      try {
        const response = await fetch('/ple-data-to-update');
        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/admin';
            return;
          }
          throw new Error('Failed to load configuration');
        }

        const data = await response.json();

        // Populate form fields
        Object.entries(fieldMappings).forEach(([fieldId, apiKey]) => {
          const element = document.getElementById(fieldId);
          if (element) {
            element.value = data[apiKey] || '';
          }
        });

        // Load and show previews
        await loadPreviews(data);
      } catch (error) {
        showMessage('Error loading configuration: ' + error.message, 'error');
        console.error('Load config error:', error);
      }
    }

    async function loadPreviews(data) {
      const previewMappings = [
        { dataKey: 'PLE_promo_ticketGraphicDesktop', previewId: 'previewGADesktop' },
        { dataKey: 'PLE_promo_ticketGraphicDesktop_next', previewId: 'previewGADesktopNext' },
        { dataKey: 'PLE_promo_ticketGraphicMobile', previewId: 'previewGAMobile' },
        { dataKey: 'PLE_promo_ticketGraphicMobile_next', previewId: 'previewGAMobileNext' },
        { dataKey: 'PLE_promo_compTicketGraphicDesktop', previewId: 'previewCompDesktop' },
        { dataKey: 'PLE_promo_compTicketGraphicDesktop_next', previewId: 'previewCompDesktopNext' },
        { dataKey: 'PLE_promo_compTicketGraphicMobile', previewId: 'previewCompMobile' },
        { dataKey: 'PLE_promo_compTicketGraphicMobile_next', previewId: 'previewCompMobileNext' }
      ];

      for (const mapping of previewMappings) {
        const url = data[mapping.dataKey];
        if (url) {
          updatePreview(mapping.previewId, url);
        }
      }
    }

    async function loadHistory() {
      try {
        const response = await fetch('/config-history?limit=100');
        if (!response.ok) throw new Error('Failed to load history');

        const history = await response.json();
        const tbody = document.getElementById('historyBody');

        if (history.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No changes yet</td></tr>';
          return;
        }

        tbody.innerHTML = history.map(entry => `
          <tr>
            <td class="timestamp">${new Date(entry.changed_at).toLocaleString()}</td>
            <td><span class="variable-name">${entry.key}</span></td>
            <td><span class="username">${entry.username || 'System'}</span></td>
            <td><div class="value-change">${entry.old_value ? truncate(entry.old_value) : '(new)'}</div></td>
            <td><div class="value-change">${entry.new_value ? truncate(entry.new_value) : '(deleted)'}</div></td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Load history error:', error);
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch('/admin/users');
        if (!response.ok) throw new Error('Failed to load users');

        const users = await response.json();
        const usersList = document.getElementById('usersList');

        if (users.length === 0) {
          usersList.innerHTML = '<div style="color: #999;">No users found</div>';
          return;
        }

        usersList.innerHTML = users.map(user => `
          <div style="padding: 12px; background: #f9f9f9; border-radius: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 500; color: #333;">${user.username}</div>
              <div style="font-size: 12px; color: #999;">Created: ${new Date(user.created_at).toLocaleDateString()}</div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Load users error:', error);
        document.getElementById('usersList').innerHTML = '<div style="color: #e74c3c;">Failed to load users</div>';
      }
    }

    async function createNewUser() {
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value.trim();

      if (!username || !password) {
        showMessage('Username and password are required', 'error');
        return;
      }

      if (username.length < 3) {
        showMessage('Username must be at least 3 characters', 'error');
        return;
      }

      if (password.length < 6) {
        showMessage('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        const response = await fetch('/admin/create-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok) {
          showMessage(`User '${username}' created successfully!`, 'success');
          document.getElementById('newUsername').value = '';
          document.getElementById('newPassword').value = '';
          // Reload users list
          await loadUsers();
        } else {
          showMessage(data.error || 'Failed to create user', 'error');
        }
      } catch (error) {
        console.error('Create user error:', error);
        showMessage('Error creating user: ' + error.message, 'error');
      }
    }

    function truncate(str, length = 50) {
      if (str.length > length) {
        return str.substring(0, length) + '...';
      }
      return str;
    }

    async function validateUrl(fieldId) {
      const input = document.getElementById(fieldId);
      const url = input.value.trim();

      if (!url) {
        showValidationStatus(fieldId, false, 'URL is required');
        return;
      }

      showValidationStatus(fieldId, 'checking', 'Checking...');

      try {
        const response = await fetch('/validate-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await response.json();

        if (data.valid) {
          showValidationStatus(fieldId, true, 'URL is accessible');
          showPreview(fieldId, url);
        } else {
          showValidationStatus(fieldId, false, `URL not accessible: ${data.error}`);
        }
      } catch (error) {
        showValidationStatus(fieldId, false, 'Validation error: ' + error.message);
      }
    }

    function showValidationStatus(fieldId, isValid, message) {
      const statusElement = document.getElementById(fieldId + '-status');
      statusElement.className = 'validation-status';
      statusElement.innerHTML = '';

      if (isValid === 'checking') {
        statusElement.classList.add('checking');
        statusElement.innerHTML = '<span class="status-indicator"></span>' + message;
      } else if (isValid) {
        statusElement.classList.add('valid');
        statusElement.innerHTML = '✓ ' + message;
      } else if (isValid === false) {
        statusElement.classList.add('invalid');
        statusElement.innerHTML = '✗ ' + message;
      }
    }

    function showPreview(fieldId, url) {
      const previewElement = document.getElementById(fieldId + '-preview');
      if (!previewElement) return;

      previewElement.style.display = 'block';
      previewElement.className = 'image-preview loading';
      previewElement.innerHTML = 'Loading preview...';

      const img = new Image();
      img.onload = () => {
        previewElement.className = 'image-preview';
        previewElement.innerHTML = `<img src="${url}" alt="Preview">`;
      };
      img.onerror = () => {
        previewElement.className = 'image-preview';
        previewElement.innerHTML = 'Failed to load image';
      };
      img.src = url;
    }

    function updatePreview(previewId, url) {
      const previewElement = document.getElementById(previewId);
      if (!previewElement || !url) return;

      const img = new Image();
      img.onload = () => {
        const headerText = previewElement.querySelector('h4') ? previewElement.querySelector('h4').textContent : '';
        previewElement.innerHTML = `<h4>${headerText}</h4><img src="${url}" alt="Preview">`;
      };
      img.onerror = () => {
        const headerText = previewElement.querySelector('h4') ? previewElement.querySelector('h4').textContent : '';
        previewElement.innerHTML = `<h4>${headerText}</h4><div class="no-image">Failed to load</div>`;
      };
      img.src = url;
    }

    function updateLivePreview(fieldId) {
      const url = document.getElementById(fieldId).value.trim();
      if (!url) return;

      // Map field IDs to preview IDs
      const previewMap = {
        gaDesktop: 'previewGADesktop',
        gaDesktopNext: 'previewGADesktopNext',
        gaMobile: 'previewGAMobile',
        gaMobileNext: 'previewGAMobileNext',
        compDesktop: 'previewCompDesktop',
        compDesktopNext: 'previewCompDesktopNext',
        compMobile: 'previewCompMobile',
        compMobileNext: 'previewCompMobileNext'
      };

      const previewId = previewMap[fieldId];
      if (previewId && (url.startsWith('http://') || url.startsWith('https://'))) {
        updatePreview(previewId, url);
      }
    }

    function updateConfigPageHighlights() {
      const switchDateStr = document.getElementById('switchDate').value;
      const isAfterSwitch = isDateInPast(switchDateStr);

      // Find all "Before switch" and "After switch" sections in config tab
      const configCard = document.getElementById('config');
      const allSections = configCard.querySelectorAll('[class*="section"]').parentElement;

      // Get all form groups that contain Desktop or Mobile inputs
      const gaDesktopSection = document.getElementById('gaDesktop').closest('div').closest('div').closest('div');
      const gaDesktopNextSection = document.getElementById('gaDesktopNext').closest('div').closest('div').closest('div');
      const gaMobileSection = document.getElementById('gaMobile').closest('div').closest('div').closest('div');
      const gaMobileNextSection = document.getElementById('gaMobileNext').closest('div').closest('div').closest('div');
      const compDesktopSection = document.getElementById('compDesktop').closest('div').closest('div').closest('div');
      const compDesktopNextSection = document.getElementById('compDesktopNext').closest('div').closest('div').closest('div');
      const compMobileSection = document.getElementById('compMobile').closest('div').closest('div').closest('div');
      const compMobileNextSection = document.getElementById('compMobileNext').closest('div').closest('div').closest('div');

      const sections = [
        { before: gaDesktopSection, after: gaDesktopNextSection },
        { before: gaMobileSection, after: gaMobileNextSection },
        { before: compDesktopSection, after: compDesktopNextSection },
        { before: compMobileSection, after: compMobileNextSection }
      ];

      sections.forEach(({ before, after }) => {
        if (before) {
          before.classList.remove('before-switch-section');
          if (!isAfterSwitch) {
            before.classList.add('before-switch-section');
          }
        }
        if (after) {
          after.classList.remove('before-switch-section');
          if (isAfterSwitch) {
            after.classList.add('before-switch-section');
          }
        }
      });
    }

    function previewConfig() {
      // Update preview highlights based on switch date
      updatePreviewHighlights();
      switchTab('preview');
    }

    function updatePreviewHighlights() {
      const switchDateStr = document.getElementById('switchDate').value;
      const isAfterSwitch = isDateInPast(switchDateStr);

      // Get all preview items and remove all highlighting classes
      const previewItems = document.querySelectorAll('.preview-item');
      previewItems.forEach(item => {
        item.classList.remove('before-switch');
        item.classList.remove('after-switch-current');
      });

      // Now add highlighting based on switch date
      previewItems.forEach(item => {
        const headerText = item.querySelector('h4') ? item.querySelector('h4').textContent : '';
        const isBeforeSwitchItem = headerText.includes('Before switch');

        if (isAfterSwitch) {
          // After switch date - highlight "After switch" items
          if (!isBeforeSwitchItem) {
            item.classList.add('after-switch-current');
          }
        } else {
          // Before switch date - highlight "Before switch" items
          if (isBeforeSwitchItem) {
            item.classList.add('before-switch');
          }
        }
      });
    }

    function isDateInPast(dateStr) {
      if (!dateStr || dateStr === 'TBD') return false;
      const switchDate = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return switchDate < today;
    }

    async function saveConfig() {
      const saveBtn = document.querySelector('.btn-save');
      saveBtn.disabled = true;
      const originalText = saveBtn.textContent;
      saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

      try {
        const updates = {};
        Object.entries(fieldMappings).forEach(([fieldId, apiKey]) => {
          const element = document.getElementById(fieldId);
          if (element) {
            updates[apiKey] = element.value.trim();
          }
        });

        const response = await fetch('/update-ple', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('Configuration saved successfully!', 'success');
          // Reload history
          await loadHistory();
        } else {
          showMessage('Error: ' + (data.error || 'Failed to save'), 'error');
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
        console.error('Save error:', error);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
    }

    function resetForm() {
      if (confirm('Are you sure? This will reload the current values from the server.')) {
        loadConfig();
      }
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    function showMessage(message, type) {
      const elements = {
        success: document.getElementById('successMessage'),
        error: document.getElementById('errorMessage'),
        info: document.getElementById('infoMessage')
      };

      const element = elements[type];
      element.textContent = message;
      element.className = `message ${type} show`;

      setTimeout(() => {
        element.classList.remove('show');
      }, 5000);
    }

    function copyAfterSwitchToBefore() {
      if (confirm('Are you sure? This will copy all "After switch" image URLs to their corresponding "Before switch" fields and clear the "After switch" fields.')) {
        // Copy GA Desktop
        const gaDesktopNext = document.getElementById('gaDesktopNext').value;
        if (gaDesktopNext) {
          document.getElementById('gaDesktop').value = gaDesktopNext;
          document.getElementById('gaDesktopNext').value = '';
        }

        // Copy GA Mobile
        const gaMobileNext = document.getElementById('gaMobileNext').value;
        if (gaMobileNext) {
          document.getElementById('gaMobile').value = gaMobileNext;
          document.getElementById('gaMobileNext').value = '';
        }

        // Copy Comp Desktop
        const compDesktopNext = document.getElementById('compDesktopNext').value;
        if (compDesktopNext) {
          document.getElementById('compDesktop').value = compDesktopNext;
          document.getElementById('compDesktopNext').value = '';
        }

        // Copy Comp Mobile
        const compMobileNext = document.getElementById('compMobileNext').value;
        if (compMobileNext) {
          document.getElementById('compMobile').value = compMobileNext;
          document.getElementById('compMobileNext').value = '';
        }

        showMessage('All "After switch" values copied to "Before switch" fields and cleared. Click Save Configuration to persist changes.', 'info');
      }
    }

    // Store for other settings
    let otherSettingsData = {};

    async function loadOtherSettings() {
      try {
        const response = await fetch('/ple-data-to-update');
        if (!response.ok) throw new Error('Failed to load settings');

        const data = await response.json();
        console.log('All config data:', data);

        // Filter out variables we already manage (ticket graphics and switch date)
        const managedKeys = [
          'PLE_promo_promo_switchDate',
          'PLE_promo_ticketGraphicDesktop',
          'PLE_promo_ticketGraphicDesktop_next',
          'PLE_promo_ticketGraphicMobile',
          'PLE_promo_ticketGraphicMobile_next',
          'PLE_promo_compTicketGraphicDesktop',
          'PLE_promo_compTicketGraphicDesktop_next',
          'PLE_promo_compTicketGraphicMobile',
          'PLE_promo_compTicketGraphicMobile_next',
          'PLE_promo_compTicketPromoLine',
          'PLE_promo_compTicketPromoLine_next',
          'PLE_promo_ticketPromoLine',
          'PLE_promo_ticketPromoLine_next'
        ];

        // Get all remaining PLE variables
        otherSettingsData = {};
        Object.entries(data).forEach(([key, value]) => {
          if (key.startsWith('PLE_') && !managedKeys.includes(key)) {
            otherSettingsData[key] = value;
          }
        });

        console.log('Other settings data:', otherSettingsData);
        renderOtherSettings();
      } catch (error) {
        console.error('Load other settings error:', error);
        const formContainer = document.getElementById('settingsForm');
        if (formContainer) {
          formContainer.innerHTML = '<p style="color: #e74c3c;">Error loading settings</p>';
        }
      }
    }

    function renderOtherSettings() {
      const formContainer = document.getElementById('settingsForm');

      if (!formContainer) {
        console.error('settingsForm container not found');
        return;
      }

      if (Object.keys(otherSettingsData).length === 0) {
        formContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No additional settings to configure. Only ticket graphics settings are available.</p>';
        return;
      }

      const isImageField = (key) => {
        const lowerKey = key.toLowerCase();
        return lowerKey.includes('image') || lowerKey.includes('url') || lowerKey.includes('graphic');
      };

      let html = '';

      Object.entries(otherSettingsData).forEach(([key, value]) => {
        // Skip _next versions - only show base fields
        if (key.endsWith('_next')) {
          return;
        }

        const label = key
          .replace('PLE_', '')
          .replace(/_/g, ' ')
          .replace(/([A-Z])/g, ' $1')
          .trim()
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');

        const isImage = isImageField(key);
        const fieldId = `setting_${key}`;

        html += `
          <div class="form-group">
            <label for="${fieldId}">${label}</label>
            <input type="text" id="${fieldId}" value="${value || ''}" placeholder="Enter value">
            ${isImage ? `<div class="image-preview" id="${fieldId}-preview" style="display: none;"></div>` : ''}
          </div>
        `;
      });

      try {
        formContainer.innerHTML = html;
      } catch (e) {
        console.error('Error rendering form HTML:', e);
        formContainer.innerHTML = '<p style="color: #e74c3c;">Error rendering settings form</p>';
        return;
      }

      // Add event listeners and load previews for image fields
      Object.entries(otherSettingsData).forEach(([key, value]) => {
        if (key.endsWith('_next')) {
          return; // Skip _next versions
        }

        const isImage = isImageField(key);
        if (isImage) {
          const fieldId = `setting_${key}`;
          const element = document.getElementById(fieldId);

          if (element) {
            // Load preview on initial load
            const url = element.value.trim();
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
              showImagePreview(fieldId, url);
            }

            // Add listener for when user updates the URL
            element.addEventListener('blur', () => {
              const newUrl = element.value.trim();
              if (newUrl && (newUrl.startsWith('http://') || newUrl.startsWith('https://'))) {
                showImagePreview(fieldId, newUrl);
              }
            });
          }
        }
      });
    }

    function showImagePreview(fieldId, url) {
      const previewElement = document.getElementById(fieldId + '-preview');
      if (!previewElement) return;

      previewElement.style.display = 'block';
      previewElement.className = 'image-preview loading';
      previewElement.innerHTML = 'Loading preview...';

      const img = new Image();
      img.onload = () => {
        previewElement.className = 'image-preview';
        previewElement.innerHTML = `<img src="${url}" alt="Preview">`;
      };
      img.onerror = () => {
        previewElement.className = 'image-preview';
        previewElement.innerHTML = 'Failed to load image';
      };
      img.src = url;
    }

    async function saveOtherSettings() {
      try {
        const updates = {};
        const formContainer = document.getElementById('settingsForm');
        const allInputs = formContainer.querySelectorAll('input[type="text"], input[type="date"]');

        allInputs.forEach(input => {
          const fieldId = input.id;
          if (fieldId.startsWith('setting_')) {
            const pleKey = fieldId.replace('setting_', '');
            updates[pleKey] = input.value.trim();
          }
        });

        const response = await fetch('/update-ple', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });

        const data = await response.json();

        if (response.ok) {
          showMessage('Settings saved successfully!', 'success');
          // Reload history
          await loadHistory();
        } else {
          showMessage('Error: ' + (data.error || 'Failed to save'), 'error');
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
        console.error('Save settings error:', error);
      }
    }

    function resetSettingsForm() {
      if (confirm('Are you sure? This will reload the current values from the server.')) {
        loadOtherSettings();
      }
    }

    async function logout() {
      if (confirm('Are you sure you want to log out?')) {
        try {
          await fetch('/logout', { method: 'POST' });
          window.location.href = '/admin';
        } catch (error) {
          console.error('Logout error:', error);
        }
      }
    }
  </script>
</body>
</html>
